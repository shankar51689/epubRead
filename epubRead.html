<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>EPUB Reader with Page Curl</title>
    
    <link rel="icon" href="data:,">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

    <style>
        body { 
            margin: 0; padding: 0; height: 100vh; 
            display: flex; flex-direction: column; 
            background: #e0e0e0; font-family: system-ui, -apple-system, sans-serif; 
            overflow: hidden;
        }
        #toolbar { 
            height: 50px; background: #222; 
            display: flex; align-items: center; 
            justify-content: space-around; padding: 0 10px; z-index: 100; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        #toolbar button { 
            background: #444; color: white; border: none; 
            padding: 8px 14px; border-radius: 4px; cursor: pointer; 
            font-size: 14px; min-width: 44px;
        }
        #toolbar button:active { background: #666; }

        /* Container for the 3D effect */
        #viewer-container {
            flex-grow: 1;
            position: relative;
            perspective: 2000px; /* Crucial for 3D depth */
            background: #d1d1d1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #viewer { 
            width: 100%;
            height: 100%;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            transition: transform 0.6s cubic-bezier(0.15, 0, 0.15, 1), opacity 0.4s;
            transform-style: preserve-3d;
        }

        /* Page Curl Classes */
        .curl-next {
            transform-origin: left center;
            transform: rotateY(-25deg) translateX(-100%);
            opacity: 0;
        }

        .curl-prev {
            transform-origin: right center;
            transform: rotateY(25deg) translateX(100%);
            opacity: 0;
        }

        #loading { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); color: #666; 
            font-weight: bold; text-align: center;
            z-index: 10;
        }
    </style>
</head>
<body>

<div id="toolbar">
    <button onclick="prev()">â—€ Prev</button>
    <button onclick="fontSize(-10)">Aâˆ’</button>
    <button onclick="toggleTheme()">ðŸŒ“</button>
    <button onclick="fontSize(10)">A+</button>
    <button onclick="next()">Next â–¶</button>
</div>

<div id="loading">Initializing Reader...</div>

<div id="viewer-container">
    <div id="viewer"></div>
</div>

<script>
    let book, rendition;
    let fontScale = 100;
    let isDark = false;
    
    // Swipe handling variables
    let touchStartX = 0;
    let touchEndX = 0;

    function initReader(url) {
        book = ePub(url);
        rendition = book.renderTo("viewer", {
            width: "100%", 
            height: "100%", 
            flow: "paginated", 
            manager: "default"
        });

        rendition.display().then(() => {
            document.getElementById('loading').style.display = 'none';
            applyStyles();
            attachGestures();
        });

        rendition.on("relocated", loc => {
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify({ type: "pageChange", data: loc.start.cfi }));
            }
        });
    }

    /* --- ANIMATION LOGIC --- */
    function animatePage(direction, callback) {
        const viewer = document.getElementById("viewer");
        
        // Add the curl class
        viewer.classList.add(direction === "next" ? "curl-next" : "curl-prev");

        // Wait for animation to finish before changing content
        setTimeout(() => {
            callback(); // Change the page content
            
            // Instantly move page to the opposite side for "entering" effect
            viewer.style.transition = "none";
            viewer.classList.remove("curl-next", "curl-prev");
            viewer.style.transform = direction === "next" ? "translateX(100%)" : "translateX(-100%)";
            
            // Slide back into view smoothly
            setTimeout(() => {
                viewer.style.transition = "transform 0.5s ease-out, opacity 0.3s";
                viewer.style.transform = "translateX(0) rotateY(0deg)";
                viewer.style.opacity = "1";
            }, 50);
        }, 500);
    }

    /* --- GESTURES --- */
    function attachGestures() {
        // We must attach listeners to the iframe content
        rendition.on("touchstart", event => {
            touchStartX = event.changedTouches[0].screenX;
        });

        rendition.on("touchend", event => {
            touchEndX = event.changedTouches[0].screenX;
            handleSwipe();
        });
    }

    function handleSwipe() {
        const distance = touchEndX - touchStartX;
        const threshold = 70; // minimum swipe distance

        if (distance < -threshold) next(); // Swipe Left -> Next
        if (distance > threshold) prev();  // Swipe Right -> Prev
    }

    /* --- BUTTON ACTIONS --- */
    function next() {
        if (!rendition) return;
        animatePage("next", () => rendition.next());
    }

    function prev() {
        if (!rendition) return;
        animatePage("prev", () => rendition.prev());
    }

    /* --- STYLING & THEME --- */
    function applyStyles() {
        if (!rendition) return;
        rendition.themes.default({
            "body": {
                "font-size": fontScale + "% !important",
                "background": isDark ? "#1a1a1a" : "#ffffff",
                "color": isDark ? "#eee" : "#000",
                "padding": "0 20px !important"
            }
        });
    }

    function fontSize(delta) {
        fontScale = Math.min(Math.max(fontScale + delta, 40), 250);
        applyStyles();
    }

    function toggleTheme() {
        isDark = !isDark;
        document.body.style.background = isDark ? "#121212" : "#e0e0e0";
        document.getElementById("viewer-container").style.background = isDark ? "#222" : "#d1d1d1";
        applyStyles();
    }

    // Auto-load if URL exists
    const params = new URLSearchParams(window.location.search);
    let url = params.get("url");
    if (url) initReader(decodeURIComponent(url));
</script>
</body>
</html>