<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Realistic 3D Page Curl Reader</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

    <style>
        body { 
            margin: 0; padding: 0; height: 100vh; 
            display: flex; flex-direction: column; 
            background: #2c2c2c; font-family: sans-serif; 
            overflow: hidden;
        }
        #toolbar { 
            height: 50px; background: #1a1a1a; 
            display: flex; align-items: center; 
            justify-content: space-around; padding: 0 10px; z-index: 1000;
            border-bottom: 1px solid #333;
        }
        #toolbar button { 
            background: #444; color: white; border: none; 
            padding: 8px 12px; border-radius: 4px; cursor: pointer; 
        }

        /* Book Container */
        #book-viewport {
            flex-grow: 1;
            position: relative;
            perspective: 2000px; /* Depth for 3D */
            background: #3a3a3a;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #viewer { 
            width: 100%; height: 100%;
            background: white;
            z-index: 1;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            position: absolute;
        }

        /* The Curl/Flip Layer */
        #page-flip-overlay {
            position: absolute;
            top: 0; right: 0;
            width: 100%; height: 100%;
            z-index: 100;
            pointer-events: none;
            display: none; /* Only visible during flip */
        }

        /* The "Back" of the turning page */
        .page-back {
            position: absolute;
            background: linear-gradient(to left, #ffffff 80%, #f0f0f0 100%);
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
            transform-origin: right center;
            z-index: 101;
        }

        /* Shadow on the page underneath */
        .page-shadow {
            position: absolute;
            background: linear-gradient(to right, rgba(0,0,0,0.2) 0%, transparent 100%);
            z-index: 99;
        }

        #loading { position: absolute; color: white; z-index: 10; font-weight: bold; }
    </style>
</head>
<body>

<div id="toolbar">
    <button onclick="prev()">â—€ Prev</button>
    <button onclick="fontSize(-10)">Aâˆ’</button>
    <button onclick="toggleTheme()">ðŸŒ“</button>
    <button onclick="fontSize(10)">A+</button>
    <button onclick="next()">Next â–¶</button>
</div>

<div id="loading">Opening Book...</div>

<div id="book-viewport">
    <div id="viewer"></div>
    <div id="page-flip-overlay">
        <div id="flip-back" class="page-back"></div>
        <div id="flip-shadow" class="page-shadow"></div>
    </div>
</div>

<script>
    let book, rendition;
    let fontScale = 100;
    let isDark = false;
    let startX = 0;
    let isDragging = false;

    const overlay = document.getElementById('page-flip-overlay');
    const flipBack = document.getElementById('flip-back');
    const flipShadow = document.getElementById('flip-shadow');

    function initReader(url) {
        book = ePub(url);
        rendition = book.renderTo("viewer", {
            width: "100%", height: "100%", flow: "paginated"
        });

        rendition.display().then(() => {
            document.getElementById('loading').style.display = 'none';
            applyStyles();
            setupCurlEffect();
        });
    }

    function setupCurlEffect() {
        rendition.on("touchstart", e => {
            startX = e.changedTouches[0].screenX;
            isDragging = true;
        });

        rendition.on("touchmove", e => {
            if (!isDragging) return;
            
            let currentX = e.changedTouches[0].screenX;
            let diff = startX - currentX; // Dragging distance

            if (diff > 20) { // Dragging Left (Next Page)
                showCurl(diff);
            }
        });

        rendition.on("touchend", e => {
            if (!isDragging) return;
            isDragging = false;
            let endX = e.changedTouches[0].screenX;
            let diff = startX - endX;

            if (diff > 120) {
                completeFlip();
            } else {
                cancelFlip();
            }
        });
    }

    function showCurl(diff) {
        const width = window.innerWidth;
        const progress = Math.min(diff / width, 1);
        
        overlay.style.display = 'block';
        
        // Calculate curl position
        // Clip-path makes the current page "disappear" from the corner
        document.getElementById('viewer').style.clipPath = 
            `polygon(0% 0%, ${100 - (progress * 100)}% 0%, ${100 - (progress * 120)}% 100%, 0% 100%)`;

        // Position the "back" of the page
        flipBack.style.width = (progress * 100) + "%";
        flipBack.style.height = "100%";
        flipBack.style.right = (100 - (progress * 110)) + "%";
        flipBack.style.transform = `rotateY(${-progress * 30}deg)`; // 3D bend
        
        // Shadow follows the fold
        flipShadow.style.width = "50px";
        flipShadow.style.height = "100%";
        flipShadow.style.right = (100 - (progress * 110)) + "%";
        flipShadow.style.opacity = progress;
    }

    function completeFlip() {
        // Animate to full flip
        const viewer = document.getElementById('viewer');
        viewer.style.transition = "clip-path 0.4s ease-in";
        viewer.style.clipPath = "polygon(0% 0%, 0% 0%, 0% 100%, 0% 100%)";
        
        setTimeout(() => {
            rendition.next();
            resetStyles();
        }, 400);
    }

    function cancelFlip() {
        const viewer = document.getElementById('viewer');
        viewer.style.transition = "clip-path 0.3s ease-out";
        viewer.style.clipPath = "polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%)";
        
        setTimeout(() => {
            resetStyles();
        }, 300);
    }

    function resetStyles() {
        const viewer = document.getElementById('viewer');
        viewer.style.transition = "none";
        viewer.style.clipPath = "none";
        overlay.style.display = 'none';
    }

    /* --- Actions --- */
    function next() {
        showCurl(window.innerWidth / 2);
        setTimeout(() => completeFlip(), 100);
    }

    function prev() {
        rendition.prev();
    }

    function applyStyles() {
        if (!rendition) return;
        rendition.themes.default({
            "body": {
                "font-size": fontScale + "% !important",
                "background": isDark ? "#1a1a1a" : "#ffffff",
                "color": isDark ? "#eee" : "#000",
                "padding": "0 25px !important"
            }
        });
    }

    function fontSize(delta) {
        fontScale = Math.min(Math.max(fontScale + delta, 40), 250);
        applyStyles();
    }

    function toggleTheme() {
        isDark = !isDark;
        document.body.style.background = isDark ? "#111" : "#2c2c2c";
        applyStyles();
    }

    const params = new URLSearchParams(window.location.search);
    let url = params.get("url");
    if (url) initReader(decodeURIComponent(url));
</script>
</body>
</html>