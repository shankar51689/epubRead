<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>EPUB Reader</title>
    
    <link rel="icon" href="data:,">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

    <style>
        body { 
            margin: 0; padding: 0; height: 100vh; 
            display: flex; flex-direction: column; 
            background: #f5f5f5; font-family: system-ui, -apple-system, sans-serif; 
            overflow: hidden;
        }
        #toolbar { 
            height: 50px; background: #222; 
            display: flex; align-items: center; 
            justify-content: space-around; padding: 0 10px; z-index: 100; 
        }
        #toolbar button { 
            background: #444; color: white; border: none; 
            padding: 8px 14px; border-radius: 4px; cursor: pointer; 
            font-size: 14px; min-width: 44px;
        }
        #toolbar button:active { background: #666; }

        #viewer { 
            flex-grow: 1; width: 100%; position: relative; 
            background: white; 
            /* Perspective helps the 3D curl look realistic */
            perspective: 1500px;
            overflow: hidden;
        }

        #loading { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); color: #666; 
            font-weight: bold; text-align: center;
        }

        /* Smooth transition for the viewer container */
        #viewer iframe {
            transition: transform 0.4s ease-in-out, opacity 0.3s;
        }
    </style>
</head>
<body>

<div id="toolbar">
    <button onclick="prev()">â—€ Prev</button>
    <button onclick="fontSize(-10)">Aâˆ’</button>
    <button onclick="toggleTheme()">ðŸŒ“</button>
    <button onclick="fontSize(10)">A+</button>
    <button onclick="next()">Next â–¶</button>
</div>

<div id="loading">Initializing Reader...</div>
<div id="viewer"></div>

<script>
    let book, rendition;
    let fontScale = 100;
    let isDark = false;
    let touchStartX = 0;
    let touchEndX = 0;

    /* --- PAGE CURL ANIMATION --- */
    function applyPageCurl(direction) {
        const iframe = document.querySelector("#viewer iframe");
        if (!iframe) return;

        // Apply 3D rotation and fade
        if (direction === "next") {
            iframe.style.transformOrigin = "left center";
            iframe.style.transform = "rotateY(-20deg) translateX(-100%)";
            iframe.style.opacity = "0";
        } else {
            iframe.style.transformOrigin = "right center";
            iframe.style.transform = "rotateY(20deg) translateX(100%)";
            iframe.style.opacity = "0";
        }

        // Reset position after navigation
        setTimeout(() => {
            iframe.style.transition = "none";
            iframe.style.transform = direction === "next" ? "translateX(100%)" : "translateX(-100%)";
            
            setTimeout(() => {
                iframe.style.transition = "transform 0.4s ease-out, opacity 0.3s";
                iframe.style.transform = "translateX(0) rotateY(0deg)";
                iframe.style.opacity = "1";
            }, 50);
        }, 400);
    }

    /* --- GESTURE HANDLING --- */
    function handleGesture() {
        const threshold = 50; // minimum distance for a swipe
        const swipeDistance = touchEndX - touchStartX;
        
        if (swipeDistance < -threshold) {
            next(); // Swiped Left -> Next Page
        } else if (swipeDistance > threshold) {
            prev(); // Swiped Right -> Prev Page
        }
    }

    /* --- READER INIT --- */
    function initReader(url) {
        book = ePub(url);
        rendition = book.renderTo("viewer", {
            width: "100%", height: "100%", flow: "paginated", manager: "default"
        });

        rendition.display().then(() => {
            document.getElementById('loading').style.display = 'none';
            applyStyles();
            
            // Attach touch listeners to the iframe content
            rendition.on("touchstart", event => {
                touchStartX = event.changedTouches[0].screenX;
            });

            rendition.on("touchend", event => {
                touchEndX = event.changedTouches[0].screenX;
                handleGesture();
            });
        });

        rendition.on("relocated", loc => {
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify({ 
                    type: "pageChange", 
                    data: loc.start.cfi 
                }));
            }
        });
    }

    /* --- STYLING --- */
    function applyStyles() {
        if (!rendition) return;
        rendition.themes.default({
            "body": {
                "font-size": fontScale + "% !important",
                "background": isDark ? "#1a1a1a" : "#ffffff",
                "color": isDark ? "#eee" : "#000",
                "padding": "0 20px !important"
            },
            "p": { "font-size": "1em !important" },
            "span": { "font-size": "1em !important" },
            "div": { "font-size": "1em !important" }
        });
    }

    function fontSize(delta) {
        fontScale += delta;
        fontScale = Math.min(Math.max(fontScale, 40), 250);
        applyStyles();
    }

    function toggleTheme() {
        isDark = !isDark;
        applyStyles();
        document.body.style.background = isDark ? "#121212" : "#f5f5f5";
    }

    function next() { 
        if (rendition) {
            applyPageCurl("next");
            rendition.next();
        }
    }

    function prev() { 
        if (rendition) {
            applyPageCurl("prev");
            rendition.prev();
        }
    }

    const params = new URLSearchParams(window.location.search);
    let url = params.get("url");
    if (url) initReader(decodeURIComponent(url));
</script>
</body>
</html>