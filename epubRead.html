<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>EPUB Page Curl Reader</title>

<!-- EPUB.js -->
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

<!-- PageFlip -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip/dist/css/page-flip.css">
<script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #f5f5f5;
  overflow: hidden;
  font-family: sans-serif;
}

#toolbar {
  height: 48px;
  background: #222;
  color: #fff;
  display: flex;
  align-items: center;
  padding: 0 8px;
  gap: 8px;
}

#toolbar button {
  background: #444;
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 4px;
  font-size: 14px;
}

#toolbar button:active {
  background: #666;
}

#book-container {
  width: 100%;
  height: calc(100% - 48px);
  display: flex;
  justify-content: center;
  align-items: center;
  background: #aaa;
}

#book {
  width: 100%;
  height: 100%;
}

.dark {
  background: #121212 !important;
}
</style>
</head>

<body>

<div id="toolbar">
  <button onclick="prevPage()">â—€</button>
  <button onclick="nextPage()">â–¶</button>
  <button onclick="toggleTheme()">ðŸŒ“</button>
  <button onclick="fontSize(-10)">Aâˆ’</button>
  <button onclick="fontSize(10)">A+</button>
</div>

<div id="book-container">
  <div id="book"></div>
</div>

<script>
/* ---------------------------------------------------
   UTIL
--------------------------------------------------- */
function getParam(name) {
  return new URLSearchParams(window.location.search).get(name);
}

const epubUrl = getParam("url");
if (!epubUrl) {
  alert("EPUB URL missing");
}

/* ---------------------------------------------------
   EPUB SETUP
--------------------------------------------------- */
let book = ePub(epubUrl);
let rendition = book.renderTo(document.createElement("div"), {
  width: 400,
  height: 600,
  flow: "paginated"
});

let pages = [];
let currentIndex = 0;
let fontScale = 100;
let isDark = false;

/* ---------------------------------------------------
   LOAD & PAGINATE
--------------------------------------------------- */
book.ready.then(async () => {
  const spine = book.spine.spineItems;

  for (let i = 0; i < spine.length; i++) {
    const section = await book.load(spine[i].href);
    pages.push(section);
  }

  initPageFlip();
});

/* ---------------------------------------------------
   PAGE FLIP
--------------------------------------------------- */
let pageFlip;

function initPageFlip() {
  pageFlip = new St.PageFlip(
    document.getElementById("book"),
    {
      width: Math.min(window.innerWidth, 400),
      height: Math.min(window.innerHeight - 48, 600),
      showCover: true,
      maxShadowOpacity: 0.4,
      mobileScrollSupport: false
    }
  );

  const htmlPages = pages.map(p =>
    `<div class="page"><div style="padding:20px">${p}</div></div>`
  );

  pageFlip.loadFromHTML(htmlPages);

  pageFlip.on("flip", e => {
    currentIndex = e.data;
    postMessage("pageChange", currentIndex);
  });
}

/* ---------------------------------------------------
   CONTROLS
--------------------------------------------------- */
function nextPage() {
  pageFlip.flipNext();
}

function prevPage() {
  pageFlip.flipPrev();
}

function toggleTheme() {
  isDark = !isDark;
  document.body.classList.toggle("dark", isDark);
  pageFlip.getPages().forEach(p => {
    p.element.style.background = isDark ? "#121212" : "#ffffff";
    p.element.style.color = isDark ? "#eaeaea" : "#000000";
  });
}

function fontSize(delta) {
  fontScale += delta;
  rendition.themes.fontSize(fontScale + "%");
}

/* ---------------------------------------------------
   RN WEBVIEW COMMUNICATION
--------------------------------------------------- */
function postMessage(type, data) {
  if (window.ReactNativeWebView) {
    window.ReactNativeWebView.postMessage(
      JSON.stringify({ type, data })
    );
  }
}

/* ---------------------------------------------------
   RESPONSIVE
--------------------------------------------------- */
window.addEventListener("resize", () => {
  if (pageFlip) {
    pageFlip.update({
      width: Math.min(window.innerWidth, 400),
      height: Math.min(window.innerHeight - 48, 600)
    });
  }
});
</script>

</body>
</html>
