<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Realistic 3D Page Curl Reader</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

    <style>
        body {
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column;
            background: #1a1a1a; font-family: sans-serif;
            overflow: hidden;
        }

        #toolbar {
            height: 50px; background: #222;
            display: flex; align-items: center;
            justify-content: space-around;
            padding: 0 10px; z-index: 2000;
            border-bottom: 1px solid #333;
        }

        #toolbar button {
            background: #444; color: white; border: none;
            padding: 8px 12px; border-radius: 4px;
            cursor: pointer;
        }

        #book-viewport {
            flex-grow: 1;
            position: relative;
            perspective: 3000px;
            background: #252525;
            overflow: hidden;
        }

        #viewer {
            width: 100%;
            height: 100%;
            background: white;
            z-index: 10;
            position: absolute;
        }

        /* Page thickness stack */
        #page-stack {
            position: absolute;
            inset: 0;
            z-index: 1;
            pointer-events: none;
        }

        .page-layer {
            position: absolute;
            inset: 0;
            background: #eaeaea;
        }

        /* Page curl */
        #page-peel {
            position: absolute;
            inset: 0;
            z-index: 100;
            display: none;
            pointer-events: none;
            background: white;
            transform-origin: right center;
            backface-visibility: hidden;
            box-shadow:
                -40px 0 60px rgba(0,0,0,0.25),
                inset -20px 0 30px rgba(0,0,0,0.15);
        }

        #peel-gradient {
            position: absolute;
            inset: 0;
            background: linear-gradient(
                to left,
                rgba(0,0,0,0.35),
                rgba(0,0,0,0.15) 20%,
                rgba(255,255,255,0.6) 60%,
                rgba(255,255,255,1)
            );
        }

        #under-shadow {
            position: absolute;
            inset: 0;
            z-index: 5;
            background: rgba(0,0,0,0.25);
            display: none;
            pointer-events: none;
        }

        #loading {
            position: absolute;
            color: white;
            z-index: 20;
            font-weight: bold;
        }
    </style>
</head>

<body>

<div id="toolbar">
    <button onclick="prev()">â—€ Prev</button>
    <button onclick="toggleRTL()">RTL</button>
    <button onclick="toggleSpread()">ðŸ“–</button>
    <button onclick="fontSize(-10)">Aâˆ’</button>
    <button onclick="fontSize(10)">A+</button>
    <button onclick="next()">Next â–¶</button>
</div>

<div id="loading">Initialising Realistic Reader...</div>

<div id="book-viewport">
    <div id="page-stack"></div>
    <div id="viewer"></div>
    <div id="under-shadow"></div>
    <div id="page-peel">
        <div id="peel-gradient"></div>
    </div>
</div>

<script>
    let book, rendition;
    let fontScale = 100;
    let isDragging = false;
    let startX = 0;

    let isRTL = false;
    let isTwoPage = false;
    let pageThickness = 8;

    const peel = document.getElementById("page-peel");
    const viewer = document.getElementById("viewer");
    const uShadow = document.getElementById("under-shadow");
    const stack = document.getElementById("page-stack");

    function initReader(url) {
        book = ePub(url);
        rendition = book.renderTo("viewer", {
            width: "100%",
            height: "100%",
            flow: "paginated"
        });

        rendition.display().then(() => {
            document.getElementById("loading").style.display = "none";
            buildStack();
            setupGestures();
        });
    }

    function buildStack() {
        stack.innerHTML = "";
        for (let i = pageThickness; i > 0; i--) {
            const layer = document.createElement("div");
            layer.className = "page-layer";
            layer.style.transform = `translateX(${i * (isRTL ? -1 : 1)}px)`;
            layer.style.opacity = 1 - i * 0.08;
            stack.appendChild(layer);
        }
    }

    function setupGestures() {
        viewer.addEventListener("mousedown", e => {
            startX = e.clientX;
            isDragging = true;
        });

        window.addEventListener("mousemove", e => {
            if (!isDragging) return;
            const diffX = startX - e.clientX;
            isRTL ? updateCurlRTL(diffX) : updateCurl(diffX);
        });

        window.addEventListener("mouseup", e => {
            if (!isDragging) return;
            isDragging = false;
            const diffX = startX - e.clientX;
            diffX > 150 ? finishFlip() : resetFlip();
        });

        rendition.on("touchstart", e => {
            startX = e.changedTouches[0].screenX;
            isDragging = true;
        });

        rendition.on("touchmove", e => {
            if (!isDragging) return;
            const diffX = startX - e.changedTouches[0].screenX;
            isRTL ? updateCurlRTL(diffX) : updateCurl(diffX);
        });

        rendition.on("touchend", e => {
            if (!isDragging) return;
            isDragging = false;
            const diffX = startX - e.changedTouches[0].screenX;
            diffX > 150 ? finishFlip() : resetFlip();
        });
    }

    function updateCurl(diffX) {
        const percent = Math.min(Math.max(diffX / window.innerWidth, 0), 1);

        peel.style.display = "block";
        uShadow.style.display = "block";
        peel.style.transformOrigin = "right center";

        viewer.style.clipPath = `polygon(
            0% 0%,
            ${100 - percent * 100}% 0%,
            ${100 - percent * 100}% 100%,
            0% 100%
        )`;

        peel.style.transform = `
            translateX(${-percent * 15}%)
            rotateY(${-percent * 160}deg)
            rotateZ(${-percent * 6}deg)
        `;

        uShadow.style.opacity = percent * 0.7;
    }

    function updateCurlRTL(diffX) {
        const percent = Math.min(Math.max(diffX / window.innerWidth, 0), 1);

        peel.style.display = "block";
        uShadow.style.display = "block";
        peel.style.transformOrigin = "left center";

        viewer.style.clipPath = `polygon(
            ${percent * 100}% 0%,
            100% 0%,
            100% 100%,
            ${percent * 100}% 100%
        )`;

        peel.style.transform = `
            translateX(${percent * 15}%)
            rotateY(${percent * 160}deg)
        `;

        uShadow.style.opacity = percent * 0.7;
    }

    function finishFlip() {
        peel.style.transition = "transform 0.6s ease";
        viewer.style.transition = "clip-path 0.6s ease";

        peel.style.transform = isRTL
            ? "translateX(30%) rotateY(180deg)"
            : "translateX(-30%) rotateY(-180deg)";

        viewer.style.clipPath = "polygon(0 0,0 0,0 100%,0 100%)";

        setTimeout(() => {
            isRTL ? rendition.prev() : rendition.next();
            clearStyles();
        }, 600);
    }

    function resetFlip() {
        peel.style.transition = "transform 0.35s ease-out";
        viewer.style.transition = "clip-path 0.35s ease-out";

        peel.style.transform = "translateX(0) rotateY(0)";
        viewer.style.clipPath = "none";

        setTimeout(clearStyles, 350);
    }

    function clearStyles() {
        peel.style.display = "none";
        uShadow.style.display = "none";
        peel.style.transition = "none";
        viewer.style.transition = "none";
        viewer.style.clipPath = "none";
    }

    function next() {
        isRTL ? rendition.prev() : rendition.next();
    }

    function prev() {
        isRTL ? rendition.next() : rendition.prev();
    }

    function toggleRTL() {
        isRTL = !isRTL;
        buildStack();
    }

    function toggleSpread() {
        isTwoPage = !isTwoPage;
        rendition.spread(isTwoPage ? "always" : "none");
    }

    function fontSize(delta) {
        fontScale = Math.min(Math.max(fontScale + delta, 40), 250);
        rendition.themes.fontSize(fontScale + "%");
    }

    const params = new URLSearchParams(window.location.search);
    const url = params.get("url");
    if (url) initReader(decodeURIComponent(url));
</script>

</body>
</html>
