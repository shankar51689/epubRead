<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>EPUB Reader</title>

<!-- ðŸ”¥ REQUIRED: JSZip (EPUB unzip ke liye) -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<!-- EPUB.js -->
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  background: #f5f5f5;
  font-family: sans-serif;
}

#toolbar {
  height: 48px;
  background: #222;
  color: white;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 0 8px;
}

#toolbar button {
  background: #444;
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 4px;
}

#viewer {
  height: calc(100% - 48px);
  width: 100%;
}
</style>
</head>

<body>

<div id="toolbar">
  <button onclick="prev()">â—€</button>
  <button onclick="next()">â–¶</button>
  <button onclick="toggleTheme()">ðŸŒ“</button>
  <button onclick="fontSize(-10)">Aâˆ’</button>
  <button onclick="fontSize(10)">A+</button>
</div>

<div id="viewer"></div>

<script>
/* ------------------ PARAM ------------------ */
function getParam(name) {
  return new URLSearchParams(window.location.search).get(name);
}

const rawUrl = getParam("url");

if (!rawUrl) {
  alert("EPUB URL missing");
}

/* ðŸ”¥ VERY IMPORTANT */
const epubUrl = decodeURIComponent(rawUrl);

/* ------------------ EPUB ------------------ */
let book = ePub(epubUrl, {
  openAs: "binary"
});

let rendition = book.renderTo("viewer", {
  width: "100%",
  height: "100%",
  flow: "paginated",
  spread: "always"
});

/* ------------------ ERROR HANDLING ------------------ */
book.on("openFailed", err => {
  if (window.ReactNativeWebView) {
    window.ReactNativeWebView.postMessage(
      JSON.stringify({ type: "openFailed", error: err.message || err })
    );
  }
});

book.ready.then(() => {
  rendition.display();
}).catch(err => {
  if (window.ReactNativeWebView) {
    window.ReactNativeWebView.postMessage(
      JSON.stringify({ type: "readyFailed", error: err.message || err })
    );
  }
});

/* ------------------ THEME ------------------ */
let fontScale = 100;
let isDark = false;

rendition.themes.register("dark", {
  body: { background: "#121212", color: "#eaeaea" }
});

rendition.themes.register("light", {
  body: { background: "#ffffff", color: "#000000" }
});

function toggleTheme() {
  isDark = !isDark;
  rendition.themes.select(isDark ? "dark" : "light");
}

function fontSize(delta) {
  fontScale += delta;
  rendition.themes.fontSize(fontScale + "%");
}

/* ------------------ NAV ------------------ */
function next() {
  rendition.next();
}

function prev() {
  rendition.prev();
}

/* ------------------ RN COMM ------------------ */
rendition.on("relocated", loc => {
  if (window.ReactNativeWebView) {
    window.ReactNativeWebView.postMessage(
      JSON.stringify({
        type: "pageChange",
        cfi: loc.start.cfi
      })
    );
  }
});
</script>

</body>
</html>
