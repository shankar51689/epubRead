<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>High-Fidelity 3D Page Flip</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

    <style>
        body { 
            margin: 0; padding: 0; height: 100vh; 
            display: flex; flex-direction: column; 
            background: #121212; font-family: sans-serif; 
            overflow: hidden;
        }
        #toolbar { 
            height: 50px; background: #1a1a1a; 
            display: flex; align-items: center; 
            justify-content: space-around; z-index: 2000;
            border-bottom: 1px solid #333;
        }
        #toolbar button { 
            background: #333; color: white; border: none; 
            padding: 8px 15px; border-radius: 5px; cursor: pointer; 
        }

        #book-viewport {
            flex-grow: 1;
            position: relative;
            perspective: 3000px; /* Strong depth for 3D effect */
            background: #222;
            display: flex; justify-content: center; align-items: center;
        }

        /* The main container for the book content */
        #viewer { 
            width: 100%; height: 100%;
            background: white;
            z-index: 5;
            position: absolute;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* The Curling Page (The part that you see folding) */
        #page-curl {
            position: absolute;
            top: 0; right: 0;
            width: 120%; height: 120%; /* Slightly larger to cover diagonals */
            z-index: 100;
            pointer-events: none;
            display: none;
            transform-origin: bottom right;
            /* Gradient simulating the curved back of a page with highlights */
            background: linear-gradient(135deg, 
                rgba(255,255,255,0) 35%, 
                rgba(0,0,0,0.1) 42%, 
                rgba(255,255,255,1) 45%, 
                rgba(240,240,240,1) 50%, 
                rgba(200,200,200,1) 55%, 
                rgba(0,0,0,0.05) 60%,
                rgba(255,255,255,0) 65%
            );
        }

        /* Shadow cast on the page beneath the fold */
        #fold-shadow {
            position: absolute;
            top: 0; right: 0;
            width: 100%; height: 100%;
            z-index: 8;
            background: radial-gradient(circle at bottom right, rgba(0,0,0,0.4) 0%, transparent 70%);
            display: none;
            pointer-events: none;
        }

        #loading { position: absolute; color: #888; z-index: 20; }
    </style>
</head>
<body>

<div id="toolbar">
    <button onclick="prev()">â—€ Prev</button>
    <button onclick="fontSize(-10)">Aâˆ’</button>
    <button onclick="toggleTheme()">ðŸŒ“</button>
    <button onclick="fontSize(10)">A+</button>
    <button onclick="next()">Next â–¶</button>
</div>

<div id="loading">Initialising 3D Reader...</div>

<div id="book-viewport">
    <div id="viewer"></div>
    <div id="fold-shadow"></div>
    <div id="page-curl"></div>
</div>

<script>
    let book, rendition;
    let fontScale = 100;
    let isDragging = false;
    let startX = 0, startY = 0;

    const curl = document.getElementById('page-curl');
    const shadow = document.getElementById('fold-shadow');
    const viewer = document.getElementById('viewer');

    function initReader(url) {
        book = ePub(url);
        rendition = book.renderTo("viewer", {
            width: "100%", height: "100%", flow: "paginated"
        });

        rendition.display().then(() => {
            document.getElementById('loading').style.display = 'none';
            setupRealisticGestures();
        });
    }

    function setupRealisticGestures() {
        rendition.on("touchstart", e => {
            startX = e.changedTouches[0].screenX;
            startY = e.changedTouches[0].screenY;
            isDragging = true;
            // Clear any lingering transitions
            viewer.style.transition = "none";
            curl.style.transition = "none";
        });

        rendition.on("touchmove", e => {
            if (!isDragging) return;
            let curX = e.changedTouches[0].screenX;
            let curY = e.changedTouches[0].screenY;
            
            let dx = startX - curX;
            let dy = startY - curY;

            if (dx > 10) { 
                requestAnimationFrame(() => applyCurlEffect(dx, dy));
            }
        });

        rendition.on("touchend", e => {
            if (!isDragging) return;
            isDragging = false;
            let finalX = e.changedTouches[0].screenX;
            
            if (startX - finalX > 150) {
                finishPageTurn();
            } else {
                cancelPageTurn();
            }
        });
    }

    function applyCurlEffect(dx, dy) {
        const width = window.innerWidth;
        const height = window.innerHeight;
        const progress = Math.min(dx / width, 1.2);

        curl.style.display = 'block';
        shadow.style.display = 'block';

        // 1. Diagonal Clipping: Creating the "peel" line
        // We calculate a triangle that grows from the bottom right
        let clipX = 100 - (progress * 130);
        let clipY = 100 - (progress * 130);
        viewer.style.clipPath = `polygon(0% 0%, 100% 0%, 100% ${clipY}%, ${clipX}% 100%, 0% 100%)`;

        // 2. Transforming the Curl Overlay
        // Move and rotate the curl layer to match the clipped edge
        // Skew and Rotate are key for the "curved paper" look
        let rotation = progress * -40;
        let tx = -progress * 100;
        let ty = -progress * 20;
        
        curl.style.transform = `translateX(${tx}%) translateY(${ty}%) rotateZ(${rotation}deg) skewX(${progress * 10}deg)`;
        
        // 3. Shadow intensity
        shadow.style.opacity = progress;
    }

    function finishPageTurn() {
        viewer.style.transition = "clip-path 0.5s ease-in, opacity 0.5s";
        curl.style.transition = "transform 0.5s ease-in, opacity 0.5s";
        
        viewer.style.clipPath = "polygon(0% 0%, 0% 0%, 0% 100%, 0% 100%)";
        curl.style.transform = "translateX(-150%) rotateZ(-60deg)";
        curl.style.opacity = "0";

        setTimeout(() => {
            rendition.next();
            resetFlipState();
        }, 500);
    }

    function cancelPageTurn() {
        viewer.style.transition = "clip-path 0.4s cubic-bezier(0.2, 0, 0.2, 1)";
        curl.style.transition = "transform 0.4s cubic-bezier(0.2, 0, 0.2, 1)";
        
        viewer.style.clipPath = "none";
        curl.style.transform = "translateX(0%) rotateZ(0deg)";

        setTimeout(() => resetFlipState(), 400);
    }

    function resetFlipState() {
        viewer.style.transition = "none";
        curl.style.transition = "none";
        viewer.style.clipPath = "none";
        curl.style.display = 'none';
        curl.style.opacity = "1";
        shadow.style.display = 'none';
    }

    /* --- Extra Controls --- */
    function next() {
        applyCurlEffect(window.innerWidth / 4, 0);
        setTimeout(() => finishPageTurn(), 50);
    }

    function prev() {
        rendition.prev();
    }

    function fontSize(delta) {
        fontScale = Math.max(40, Math.min(250, fontScale + delta));
        rendition.themes.fontSize(fontScale + "%");
    }

    function toggleTheme() {
        // Theme logic
    }

    const params = new URLSearchParams(window.location.search);
    let url = params.get("url");
    if (url) initReader(decodeURIComponent(url));
</script>
</body>
</html>