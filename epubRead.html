<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Realistic 3D Page Curl Reader</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

    <style>
        body {
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column;
            background: #1a1a1a; font-family: 'Georgia', serif;
            overflow: hidden;
            user-select: none;
        }

        #toolbar {
            height: 50px; background: #222;
            display: flex; align-items: center;
            justify-content: space-between;
            padding: 0 20px; z-index: 2000;
            border-bottom: 1px solid #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        #toolbar button {
            background: #444; color: #eee; border: none;
            padding: 8px 16px; border-radius: 4px;
            cursor: pointer; font-size: 14px;
            transition: background 0.2s;
        }
        #toolbar button:active { background: #666; }

        #book-viewport {
            flex-grow: 1;
            position: relative;
            background: #252525;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 2000px; /* Deep perspective for 3D feel */
        }

        #viewer {
            width: 100%; height: 100%;
            background: #fdfaf5; /* Paper color */
            z-index: 10;
            position: absolute;
        }

        /* ===== THE PEEL ELEMENT ===== */
        #page-peel {
            position: absolute;
            top: 0; 
            width: 100%; height: 100%;
            z-index: 100;
            pointer-events: none;
            display: none;
            background: #fdfaf5; /* Matches viewer bg */
            backface-visibility: hidden;
            will-change: transform, clip-path;
            
            /* The realistic spine shadow */
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }

        /* Gradient that simulates the curve lighting */
        #peel-gradient {
            position: absolute;
            inset: 0;
            background: linear-gradient(
                to left,
                rgba(0,0,0,0.2) 0%,
                rgba(255,255,255,0.4) 15%,
                rgba(0,0,0,0.05) 40%,
                transparent 100%
            );
        }

        /* The shadow cast onto the page below */
        #drop-shadow {
            position: absolute;
            top: 0; width: 100%; height: 100%;
            z-index: 50;
            background: rgba(0,0,0,0.4);
            display: none;
            pointer-events: none;
            transition: opacity 0.1s;
        }

        #loading {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #888; z-index: 20;
            font-family: sans-serif;
            text-align: center;
        }
    </style>
</head>

<body>

<div id="toolbar">
    <button onclick="triggerPrev()">◀ Prev</button>
    <div style="color:#666; font-size:12px">Drag page edges to flip</div>
    <button onclick="triggerNext()">Next ▶</button>
</div>

<div id="loading">Loading Book...</div>

<div id="book-viewport">
    <div id="viewer"></div>
    
    <div id="drop-shadow"></div>
    
    <div id="page-peel">
        <div id="peel-gradient"></div>
    </div>
</div>

<script>
    let book, rendition;
    let isDragging = false;
    let startX = 0;
    let width = window.innerWidth;

    // Elements
    const peel = document.getElementById('page-peel');
    const peelGrad = document.getElementById('peel-gradient');
    const viewer = document.getElementById('viewer');
    const dropShadow = document.getElementById('drop-shadow');

    // Default book if none provided (Alice in Wonderland)
    const DEFAULT_BOOK = "https://s3.amazonaws.com/moby-dick/moby-dick.epub";

    function initReader(url) {
        book = ePub(url);
        rendition = book.renderTo("viewer", {
            width: "100%", height: "100%", flow: "paginated"
        });

        rendition.display().then(() => {
            document.getElementById('loading').style.display = 'none';
            setupGestures();
            
            // Set initial theme to match paper
            rendition.themes.register("paper", { body: { background: "#fdfaf5" } });
            rendition.themes.select("paper");
        });
    }

    /* =========================================
       GESTURE HANDLING (SWIPE & DRAG)
       ========================================= */
    function setupGestures() {
        rendition.on("touchstart", e => {
            startX = e.changedTouches[0].screenX;
            isDragging = true;
            width = window.innerWidth;
            
            // Reset transitions for instant drag response
            peel.style.transition = 'none';
            dropShadow.style.transition = 'none';
        });

        rendition.on("touchmove", e => {
            if (!isDragging) return;
            const currentX = e.changedTouches[0].screenX;
            const diff = startX - currentX;
            
            // Determine direction based on drag
            if (diff > 0) {
                // Dragging Left (NEXT Page)
                updatePeelNext(diff);
            } else {
                // Dragging Right (PREV Page)
                updatePeelPrev(Math.abs(diff));
            }
        });

        rendition.on("touchend", e => {
            if (!isDragging) return;
            isDragging = false;
            const diff = startX - e.changedTouches[0].screenX;

            // Threshold to complete the flip
            if (diff > 100) finishNext();
            else if (diff < -100) finishPrev();
            else resetFlip();
        });
    }

    /* =========================================
       ANIMATION LOGIC: NEXT (Right to Left)
       ========================================= */
    // Simulates the CURRENT page peeling away to reveal the next one
    function updatePeelNext(diff) {
        // limit diff to screen width
        const progress = Math.min(Math.max(diff / width, 0), 1);
        
        peel.style.display = "block";
        dropShadow.style.display = "block";
        
        // Settings for Next: Anchor Right
        peel.style.transformOrigin = "center right"; 
        peel.style.left = "0";
        peel.style.right = "auto";

        // Calculate rotation and clip
        // As we drag left, we clip the right side of the peel
        const clipX = 100 - (progress * 100);
        
        // Visuals
        peel.style.clipPath = `polygon(0 0, ${clipX}% 0, ${clipX}% 100%, 0% 100%)`;
        peel.style.transform = `translateX(${-progress * 20}px) rotateY(${-progress * 20}deg)`;
        
        // Gradient follows the fold
        peelGrad.style.background = `linear-gradient(to left, rgba(0,0,0,0) ${clipX-10}%, rgba(0,0,0,0.2) ${clipX}%, rgba(255,255,255,0.5) ${clipX+5}%)`;
        
        dropShadow.style.background = `linear-gradient(to right, rgba(0,0,0,0) ${clipX-10}%, rgba(0,0,0,0.5) ${clipX}%)`;
        dropShadow.style.opacity = progress;
    }

    function finishNext() {
        peel.style.transition = "all 0.4s ease-out";
        dropShadow.style.transition = "all 0.4s ease-out";

        // Animate fully to left
        peel.style.clipPath = `polygon(0 0, 0% 0, 0% 100%, 0% 100%)`;
        dropShadow.style.opacity = 0;

        // Actually change page in epub.js
        rendition.next().then(() => {
            setTimeout(() => {
                peel.style.display = "none";
                dropShadow.style.display = "none";
                // Reset styles
                peel.style.clipPath = "none";
                peel.style.transform = "none";
            }, 300); // Wait for transition
        });
    }

    /* =========================================
       ANIMATION LOGIC: PREV (Left to Right)
       ========================================= */
    // Simulates the PREVIOUS page falling on top of the current one
    function updatePeelPrev(diff) {
        const progress = Math.min(Math.max(diff / width, 0), 1);
        
        peel.style.display = "block";
        dropShadow.style.display = "block";

        // Settings for Prev: Anchor Left
        peel.style.transformOrigin = "center left";
        peel.style.left = "0"; 

        // For PREV, the peel represents the NEW page coming in.
        // It starts clipped at 0 and grows to 100.
        const clipX = progress * 100;

        peel.style.clipPath = `polygon(0 0, ${clipX}% 0, ${clipX}% 100%, 0% 100%)`;
        
        // Add a slight curl lift
        const lift = (1 - progress) * 15; // Degrees
        peel.style.transform = `translateX(0) rotateY(${lift}deg)`;

        // Gradient logic flipped
        peelGrad.style.background = `linear-gradient(to right, rgba(255,255,255,0) ${clipX-15}%, rgba(0,0,0,0.1) ${clipX}%, rgba(0,0,0,0) ${clipX+5}%)`;
        
        dropShadow.style.background = `linear-gradient(to right, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0) ${clipX}%)`;
        dropShadow.style.opacity = progress;
    }

    function finishPrev() {
        // We need to load the previous page BEHIND the peel, 
        // then animate the peel closing shut.
        
        // 1. Immediately Snap Peel to Full Screen (User expects page is there)
        peel.style.transition = "all 0.3s ease-out";
        peel.style.clipPath = `polygon(0 0, 100% 0, 100% 100%, 0% 100%)`;
        peel.style.transform = `rotateY(0deg)`;
        dropShadow.style.opacity = 0;

        // 2. Load the actual Previous Page data
        rendition.prev().then(() => {
            // 3. Once loaded, hide the peel (user won't notice swap because visual is identical)
            setTimeout(() => {
                peel.style.display = "none";
                dropShadow.style.display = "none";
            }, 100);
        });
    }

    /* =========================================
       UTILS & BUTTON TRIGGERS
       ========================================= */
    
    function resetFlip() {
        peel.style.transition = "all 0.3s ease-out";
        peel.style.clipPath = "none"; 
        peel.style.display = "none";
        dropShadow.style.display = "none";
    }

    function triggerNext() {
        width = window.innerWidth;
        // Programmatic Animation
        let start = 0;
        const animate = () => {
            start += 25; // Speed
            if (start < width) {
                updatePeelNext(start);
                requestAnimationFrame(animate);
            } else {
                finishNext();
            }
        };
        animate();
    }

    function triggerPrev() {
        width = window.innerWidth;
        // Programmatic Animation
        let start = 0;
        const animate = () => {
            start += 25;
            if (start < width) {
                updatePeelPrev(start);
                requestAnimationFrame(animate);
            } else {
                finishPrev();
            }
        };
        animate();
    }

    // INIT
    const params = new URLSearchParams(window.location.search);
    const url = params.get("url") || DEFAULT_BOOK;
    initReader(decodeURIComponent(url));

</script>
</body>
</html>