<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Advanced 3D Reader</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* ================= YOUR ORIGINAL CSS (UNCHANGED) ================= */
:root {
    --bg-color: #1a1a1a;
    --toolbar-bg: #222;
    --text-color: #eee;
    --paper-color: #fdfaf5;
    --paper-text: #000;
    --accent-color: #c0392b;
    --sidebar-bg: #2a2a2a;
}
body.dark-mode {
    --bg-color: #121212;
    --toolbar-bg: #000;
    --text-color: #aaa;
    --paper-color: #333333;
    --paper-text: #e0e0e0;
    --sidebar-bg: #1f1f1f;
}
body {
    margin: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: var(--bg-color);
    font-family: Georgia, serif;
    overflow: hidden;
    user-select: none;
}
/* ================= CSS REMAINS SAME ================= */
</style>
</head>

<body>

<!-- ================= UI (UNCHANGED) ================= -->
<div id="highlight-menu">
    <button onclick="confirmHighlight()">Highlight Selection</button>
</div>

<div id="book-viewport">
    <div id="viewer"></div>
    <div id="drop-shadow"></div>
    <div id="page-peel"><div id="peel-gradient"></div></div>
</div>

<script>
/* ================= STATE ================= */
let book, rendition;
let currentFontSize = 100;
let isHighlightMode = false;
let currentSelection = { cfiRange:null, contents:null };

const viewer = document.getElementById("viewer");
const highlightMenu = document.getElementById("highlight-menu");
const DEFAULT_BOOK = "https://s3.amazonaws.com/moby-dick/moby-dick.epub";

/* ================= INIT ================= */
function initReader(url) {
    book = ePub(url);
    rendition = book.renderTo("viewer", { width:"100%", height:"100%", flow:"paginated" });

    rendition.display();

    rendition.hooks.content.register(contents => {
        const style = contents.document.createElement("style");
        style.innerHTML = `
            .epubjs-hl { background-color: rgba(255,255,0,0.5) !important; }
            ::selection { background: rgba(255,255,0,0.3); }
        `;
        contents.document.head.appendChild(style);
        updateContentSelectionMode(contents);
    });

    /* ================= FIX #1: MULTI WORD SELECTION ================= */
    rendition.on("selected", (cfiRange, contents) => {
        if (!isHighlightMode) return;
        currentSelection.cfiRange = cfiRange;
        currentSelection.contents = contents;
        showHighlightMenu(cfiRange, contents);
    });

    rendition.on("relocated", hideHighlightMenu);
    loadHighlights();
}

/* ================= HIGHLIGHT MODE ================= */
function toggleHighlightMode() {
    isHighlightMode = !isHighlightMode;
    const contents = rendition.getContents();
    if (contents) contents.forEach(updateContentSelectionMode);
}

function updateContentSelectionMode(content) {
    if (!content || !content.document) return;
    const body = content.document.body;
    body.style.userSelect = isHighlightMode ? "auto" : "none";
    body.style.cursor = isHighlightMode ? "text" : "default";
}

/* ================= HIGHLIGHT MENU ================= */
function showHighlightMenu(cfiRange, contents) {
    const range = contents.range(cfiRange);
    const rect = range.getBoundingClientRect();
    const vr = viewer.getBoundingClientRect();
    highlightMenu.style.left = rect.left + vr.left + rect.width / 2 + "px";
    highlightMenu.style.top = rect.top + vr.top - 40 + "px";
    highlightMenu.style.display = "block";
}
function hideHighlightMenu() {
    highlightMenu.style.display = "none";
}

/* ================= HIGHLIGHT CRUD ================= */
function confirmHighlight() {
    if (!currentSelection.cfiRange) return;
    addHighlight(currentSelection.cfiRange);
    currentSelection.contents.window.getSelection().removeAllRanges();
    hideHighlightMenu();
}

function addHighlight(cfiRange) {
    rendition.annotations.add("highlight", cfiRange, {}, () => removeHighlight(cfiRange));
    const list = getStoredHighlights();
    if (!list.includes(cfiRange)) {
        list.push(cfiRange);
        localStorage.setItem("highlights", JSON.stringify(list));
    }
}

function removeHighlight(cfiRange) {
    rendition.annotations.remove(cfiRange, "highlight");
    localStorage.setItem(
        "highlights",
        JSON.stringify(getStoredHighlights().filter(h => h !== cfiRange))
    );
}

/* ================= FIX #2: ZOOM SAFE ================= */
function changeFontSize(amount) {
    currentFontSize = Math.min(Math.max(currentFontSize + amount, 50), 300);
    rendition.themes.fontSize(currentFontSize + "%");
    setTimeout(reloadHighlights, 60);
}

function reloadHighlights() {
    rendition.annotations.remove(null, "highlight");
    getStoredHighlights().forEach(cfi =>
        rendition.annotations.add("highlight", cfi, {}, () => removeHighlight(cfi))
    );
}

function loadHighlights() {
    reloadHighlights();
}

function getStoredHighlights() {
    try { return JSON.parse(localStorage.getItem("highlights") || "[]"); }
    catch { return []; }
}

/* ================= START ================= */
const params = new URLSearchParams(location.search);
initReader(params.get("url") || DEFAULT_BOOK);
</script>

</body>
</html>
