<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Enhanced Realistic 3D Page Curl Reader</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-color: #1a1a1a;
            --toolbar-bg: #222;
            --text-color: #eee;
            --paper-color: #fdfaf5;
            --paper-text: #000;
        }

        body.dark-mode {
            --bg-color: #121212;
            --toolbar-bg: #000;
            --text-color: #aaa;
            --paper-color: #333333; /* Dark paper */
            --paper-text: #e0e0e0;
        }

        body {
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column;
            background: var(--bg-color); font-family: 'Georgia', serif;
            overflow: hidden;
            user-select: none;
            transition: background 0.3s;
        }

        /* ===== TOOLBAR ===== */
        #toolbar {
            height: 50px; background: var(--toolbar-bg);
            display: flex; align-items: center;
            justify-content: space-between;
            padding: 0 15px; z-index: 2000;
            border-bottom: 1px solid #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            transition: background 0.3s;
        }

        .toolbar-group { display: flex; gap: 8px; align-items: center; }

        #toolbar button {
            background: #444; color: #eee; border: none;
            width: 32px; height: 32px; border-radius: 4px;
            cursor: pointer; font-size: 14px;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        #toolbar button:hover { background: #555; }
        #toolbar button:active { background: #666; }
        #toolbar button.active { background: #c0392b; color: white; }

        #search-input {
            background: #333; border: 1px solid #444;
            color: white; padding: 5px 10px; border-radius: 4px;
            width: 120px; transition: width 0.3s;
        }
        #search-input:focus { width: 180px; outline: none; border-color: #666; }

        /* ===== SIDEBAR (TOC & SEARCH) ===== */
        #sidebar {
            position: absolute; top: 50px; left: 0; bottom: 0;
            width: 280px; background: #2a2a2a;
            z-index: 1500;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            border-right: 1px solid #444;
            display: flex; flex-direction: column;
        }
        #sidebar.open { transform: translateX(0); }
        
        .sidebar-header {
            padding: 10px; background: #222; color: #fff;
            font-family: sans-serif; font-weight: bold;
            border-bottom: 1px solid #333;
        }
        
        .sidebar-item {
            padding: 10px 15px; border-bottom: 1px solid #333;
            color: #ccc; cursor: pointer; font-family: sans-serif; font-size: 14px;
        }
        .sidebar-item:hover { background: #333; color: white; }
        .sidebar-item.result { border-left: 3px solid #c0392b; background: #252525; }

        /* ===== BOOK VIEWPORT ===== */
        #book-viewport {
            flex-grow: 1;
            position: relative;
            background: #252525;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 2000px;
        }

        #viewer {
            width: 100%; height: 100%;
            background: var(--paper-color);
            z-index: 10;
            position: absolute;
            transition: background 0.3s;
        }

        /* ===== THE PEEL ELEMENT ===== */
        #page-peel {
            position: absolute;
            top: 0; 
            width: 100%; height: 100%;
            z-index: 100;
            pointer-events: none;
            display: none;
            background: var(--paper-color);
            backface-visibility: hidden;
            will-change: transform, clip-path;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
            transition: background 0.3s; /* Smooth dark mode transition */
        }

        #peel-gradient {
            position: absolute; inset: 0;
            background: linear-gradient(
                to left,
                rgba(0,0,0,0.2) 0%,
                rgba(255,255,255,0.4) 15%,
                rgba(0,0,0,0.05) 40%,
                transparent 100%
            );
        }

        #drop-shadow {
            position: absolute;
            top: 0; width: 100%; height: 100%;
            z-index: 50;
            background: rgba(0,0,0,0.4);
            display: none;
            pointer-events: none;
            transition: opacity 0.1s;
        }

        #loading {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #888; z-index: 20;
            font-family: sans-serif; text-align: center;
        }

        #notification {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white;
            padding: 10px 20px; border-radius: 20px;
            font-family: sans-serif; font-size: 12px;
            opacity: 0; transition: opacity 0.3s;
            pointer-events: none; z-index: 3000;
        }
    </style>
</head>

<body>

<div id="toolbar">
    <div class="toolbar-group">
        <button onclick="toggleSidebar()" title="Table of Contents"><i class="fas fa-list"></i></button>
        <button onclick="saveBookmark()" id="btn-bookmark" title="Bookmark Page"><i class="fas fa-bookmark"></i></button>
    </div>

    <div class="toolbar-group">
        <button onclick="triggerPrev()"><i class="fas fa-chevron-left"></i></button>
        <span style="color:#666; font-size:12px; margin:0 5px;">Swipe/Drag</span>
        <button onclick="triggerNext()"><i class="fas fa-chevron-right"></i></button>
    </div>

    <div class="toolbar-group">
        <input type="text" id="search-input" placeholder="Search..." onkeydown="handleSearch(event)">
        <button onclick="changeFontSize(10)" title="Zoom In"><i class="fas fa-plus"></i></button>
        <button onclick="changeFontSize(-10)" title="Zoom Out"><i class="fas fa-minus"></i></button>
        <button onclick="toggleTheme()" title="Dark/Light Mode"><i class="fas fa-adjust"></i></button>
    </div>
</div>

<div id="sidebar">
    <div class="sidebar-header" id="sidebar-title">Contents</div>
    <div id="sidebar-content"></div>
</div>

<div id="loading">Loading Book...</div>
<div id="notification">Notification</div>

<div id="book-viewport">
    <div id="viewer"></div>
    <div id="drop-shadow"></div>
    <div id="page-peel">
        <div id="peel-gradient"></div>
    </div>
</div>

<script>
    let book, rendition;
    let isDragging = false;
    let startX = 0;
    let width = window.innerWidth;

    // State Variables
    let currentFontSize = 100;
    let isDarkMode = false;
    let storedLocations = [];

    // Elements
    const peel = document.getElementById('page-peel');
    const peelGrad = document.getElementById('peel-gradient');
    const viewer = document.getElementById('viewer');
    const dropShadow = document.getElementById('drop-shadow');
    const sidebar = document.getElementById('sidebar');
    const sidebarContent = document.getElementById('sidebar-content');

    // Default book
    const DEFAULT_BOOK = "https://s3.amazonaws.com/moby-dick/moby-dick.epub";

    function initReader(url) {
        book = ePub(url);
        rendition = book.renderTo("viewer", {
            width: "100%", height: "100%", flow: "paginated"
        });

        // Load saved location if exists
        const savedLocation = localStorage.getItem('book-location');
        const startOptions = savedLocation ? { cfi: savedLocation } : {};

        rendition.display(startOptions.cfi).then(() => {
            document.getElementById('loading').style.display = 'none';
            setupGestures();
            setupThemes();
            generateTOC();
            
            // Auto-save location on every page turn
            rendition.on('relocated', (location) => {
                localStorage.setItem('book-location', location.start.cfi);
                checkBookmarkStatus(location.start.cfi);
            });
        });

        // Generate locations for search (this might take a moment)
        book.ready.then(() => {
            book.locations.generate(1000); 
        });
    }

    /* =========================================
       NEW FUNCTIONALITY: THEMES, ZOOM, TOC, SEARCH
       ========================================= */

    function setupThemes() {
        rendition.themes.register("light", { 
            body: { color: "#000", background: "#fdfaf5", "font-family": "Georgia" } 
        });
        rendition.themes.register("dark", { 
            body: { color: "#dcdcdc", background: "#333333", "font-family": "Georgia" } 
        });
        rendition.themes.select("light");
    }

    function toggleTheme() {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('dark-mode');
        
        if (isDarkMode) {
            rendition.themes.select("dark");
            // Important: Update the PEEL element so the curl looks like the dark page
            peel.style.background = "#333333"; 
        } else {
            rendition.themes.select("light");
            peel.style.background = "#fdfaf5";
        }
    }

    function changeFontSize(amount) {
        currentFontSize += amount;
        if(currentFontSize < 50) currentFontSize = 50;
        if(currentFontSize > 300) currentFontSize = 300;
        rendition.themes.fontSize(currentFontSize + "%");
        showNotification(`Zoom: ${currentFontSize}%`);
    }

    function toggleSidebar() {
        sidebar.classList.toggle('open');
        // Reset to TOC when opening if it was showing search results
        if(sidebar.classList.contains('open') && document.getElementById('sidebar-title').innerText === 'Search Results') {
            generateTOC();
        }
    }

    function generateTOC() {
        document.getElementById('sidebar-title').innerText = "Table of Contents";
        sidebarContent.innerHTML = "";
        
        book.loaded.navigation.then(function(toc) {
            toc.forEach(function(chapter) {
                let item = document.createElement("div");
                item.className = "sidebar-item";
                item.innerText = chapter.label.trim();
                item.onclick = function() {
                    rendition.display(chapter.href);
                    sidebar.classList.remove('open');
                };
                sidebarContent.appendChild(item);
            });
        });
    }

    function handleSearch(e) {
        if (e.key === 'Enter') {
            const query = e.target.value;
            if(!query) return;
            
            showNotification("Searching...");
            document.getElementById('sidebar-title').innerText = "Search Results";
            sidebarContent.innerHTML = "<div class='sidebar-item'>Searching...</div>";
            if(!sidebar.classList.contains('open')) sidebar.classList.add('open');

            // ePubJS search
            Promise.all(
                book.spine.spineItems.map(item => 
                    item.load(book.load.bind(book))
                    .then(item.find.bind(item, query))
                    .finally(item.unload.bind(item))
                )
            ).then(results => {
                sidebarContent.innerHTML = "";
                let count = 0;
                // Flatten results
                const allResults = [].concat.apply([], results);
                
                if(allResults.length === 0) {
                    sidebarContent.innerHTML = "<div class='sidebar-item'>No results found.</div>";
                    return;
                }

                allResults.forEach(result => {
                    let item = document.createElement("div");
                    item.className = "sidebar-item result";
                    // Clean up result excerpt
                    const excerpt = result.excerpt.replace(query, `<b>${query}</b>`);
                    item.innerHTML = `...${excerpt}...`;
                    item.onclick = function() {
                        rendition.display(result.cfi);
                        sidebar.classList.remove('open');
                    };
                    sidebarContent.appendChild(item);
                    count++;
                });
                showNotification(`Found ${count} matches`);
            });
        }
    }

    /* =========================================
       BOOKMARKING
       ========================================= */
    function saveBookmark() {
        const currentLoc = rendition.currentLocation().start.cfi;
        const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || "[]");
        
        // Toggle bookmark
        if(bookmarks.includes(currentLoc)) {
            const index = bookmarks.indexOf(currentLoc);
            bookmarks.splice(index, 1);
            showNotification("Bookmark Removed");
            document.getElementById('btn-bookmark').classList.remove('active');
        } else {
            bookmarks.push(currentLoc);
            showNotification("Page Bookmarked");
            document.getElementById('btn-bookmark').classList.add('active');
        }
        localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
    }

    function checkBookmarkStatus(cfi) {
        const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || "[]");
        if(bookmarks.includes(cfi)) {
            document.getElementById('btn-bookmark').classList.add('active');
        } else {
            document.getElementById('btn-bookmark').classList.remove('active');
        }
    }

    function showNotification(msg) {
        const note = document.getElementById('notification');
        note.innerText = msg;
        note.style.opacity = '1';
        setTimeout(() => { note.style.opacity = '0'; }, 2000);
    }

    /* =========================================
       EXISTING CURL ANIMATION LOGIC (UNCHANGED)
       ========================================= */
    function setupGestures() {
        rendition.on("touchstart", e => {
            startX = e.changedTouches[0].screenX;
            isDragging = true;
            width = window.innerWidth;
            peel.style.transition = 'none';
            dropShadow.style.transition = 'none';
        });

        rendition.on("touchmove", e => {
            if (!isDragging) return;
            const currentX = e.changedTouches[0].screenX;
            const diff = startX - currentX;
            if (diff > 0) { updatePeelNext(diff); } 
            else { updatePeelPrev(Math.abs(diff)); }
        });

        rendition.on("touchend", e => {
            if (!isDragging) return;
            isDragging = false;
            const diff = startX - e.changedTouches[0].screenX;
            if (diff > 100) finishNext();
            else if (diff < -100) finishPrev();
            else resetFlip();
        });
    }

    function updatePeelNext(diff) {
        const progress = Math.min(Math.max(diff / width, 0), 1);
        peel.style.display = "block";
        dropShadow.style.display = "block";
        peel.style.transformOrigin = "center right"; 
        peel.style.left = "0";
        peel.style.right = "auto";
        const clipX = 100 - (progress * 100);
        peel.style.clipPath = `polygon(0 0, ${clipX}% 0, ${clipX}% 100%, 0% 100%)`;
        peel.style.transform = `translateX(${-progress * 20}px) rotateY(${-progress * 20}deg)`;
        peelGrad.style.background = `linear-gradient(to left, rgba(0,0,0,0) ${clipX-10}%, rgba(0,0,0,0.2) ${clipX}%, rgba(255,255,255,0.5) ${clipX+5}%)`;
        dropShadow.style.background = `linear-gradient(to right, rgba(0,0,0,0) ${clipX-10}%, rgba(0,0,0,0.5) ${clipX}%)`;
        dropShadow.style.opacity = progress;
    }

    function finishNext() {
        peel.style.transition = "all 0.4s ease-out";
        dropShadow.style.transition = "all 0.4s ease-out";
        peel.style.clipPath = `polygon(0 0, 0% 0, 0% 100%, 0% 100%)`;
        dropShadow.style.opacity = 0;
        rendition.next().then(() => {
            setTimeout(() => {
                peel.style.display = "none";
                dropShadow.style.display = "none";
                peel.style.clipPath = "none";
                peel.style.transform = "none";
            }, 300);
        });
    }

    function updatePeelPrev(diff) {
        const progress = Math.min(Math.max(diff / width, 0), 1);
        peel.style.display = "block";
        dropShadow.style.display = "block";
        peel.style.transformOrigin = "center left";
        peel.style.left = "0"; 
        const clipX = progress * 100;
        peel.style.clipPath = `polygon(0 0, ${clipX}% 0, ${clipX}% 100%, 0% 100%)`;
        const lift = (1 - progress) * 15; 
        peel.style.transform = `translateX(0) rotateY(${lift}deg)`;
        peelGrad.style.background = `linear-gradient(to right, rgba(255,255,255,0) ${clipX-15}%, rgba(0,0,0,0.1) ${clipX}%, rgba(0,0,0,0) ${clipX+5}%)`;
        dropShadow.style.background = `linear-gradient(to right, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0) ${clipX}%)`;
        dropShadow.style.opacity = progress;
    }

    function finishPrev() {
        peel.style.transition = "all 0.3s ease-out";
        peel.style.clipPath = `polygon(0 0, 100% 0, 100% 100%, 0% 100%)`;
        peel.style.transform = `rotateY(0deg)`;
        dropShadow.style.opacity = 0;
        rendition.prev().then(() => {
            setTimeout(() => {
                peel.style.display = "none";
                dropShadow.style.display = "none";
            }, 100);
        });
    }

    function resetFlip() {
        peel.style.transition = "all 0.3s ease-out";
        peel.style.clipPath = "none"; 
        peel.style.display = "none";
        dropShadow.style.display = "none";
    }

    function triggerNext() {
        width = window.innerWidth;
        let start = 0;
        const animate = () => {
            start += 25; 
            if (start < width) {
                updatePeelNext(start);
                requestAnimationFrame(animate);
            } else { finishNext(); }
        };
        animate();
    }

    function triggerPrev() {
        width = window.innerWidth;
        let start = 0;
        const animate = () => {
            start += 25;
            if (start < width) {
                updatePeelPrev(start);
                requestAnimationFrame(animate);
            } else { finishPrev(); }
        };
        animate();
    }

    // INIT
    const params = new URLSearchParams(window.location.search);
    const url = params.get("url") || DEFAULT_BOOK;
    initReader(decodeURIComponent(url));

</script>
</body>
</html>